<!--
    ==================================================
    ingrid-harvester
    ==================================================
    Copyright (C) 2017 - 2023 wemove digital solutions GmbH
    ==================================================
    Licensed under the EUPL, Version 1.2 or - as soon they will be
    approved by the European Commission - subsequent versions of the
    EUPL (the "Licence");

    You may not use this work except in compliance with the Licence.
    You may obtain a copy of the Licence at:

    https://joinup.ec.europa.eu/collection/eupl/eupl-text-eupl-12

    Unless required by applicable law or agreed to in writing, software
    distributed under the Licence is distributed on an "AS IS" basis,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the Licence for the specific language governing permissions and
    limitations under the Licence.
    ==================================================
-->

<div *ngIf="configForm" class="form-wrapper">

  <form [formGroup]="configForm">

    <mat-card class="margin-below" [formGroup]="configForm.get('database')">
      <mat-card-header>
        <mat-card-title>Datenbank</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div fxLayout="row" fxLayoutGap="20px grid" fxLayoutAlign="left" class="margin-below">
          <mat-form-field fxFlex="6">
            <mat-select placeholder="Datenbank" formControlName="type" required>
              <mat-option value="postgresql">PostgreSQL</mat-option>
            </mat-select>
          </mat-form-field>
          <mat-form-field fxFlex="20">
            <input matInput type="url" placeholder="URL" formControlName="host" required>
            <mat-error *ngIf="configForm.get('database.host').hasError('required')">
              Dies ist ein Pflichtfeld
            </mat-error>
          </mat-form-field>
          <mat-form-field fxFlex="4">
            <input matInput type="number" placeholder="Port" formControlName="port" required>
            <mat-error *ngIf="configForm.get('database.port').hasError('required')">
              Dies ist ein Pflichtfeld
            </mat-error>
          </mat-form-field>
        </div>
        <div fxLayout="row" fxLayoutGap="20px grid" fxLayoutAlign="left" class="margin-below">
          <mat-form-field fxFlex="30">
            <input matInput placeholder="Datenbank-Name" formControlName="database" required>
            <mat-error *ngIf="configForm.get('database.database').hasError('whitespace')">
              Es dürfen nicht nur Leerzeichen eingegeben sein
            </mat-error>
            <mat-error *ngIf="configForm.get('database.database').hasError('required')">
              Dies ist ein Pflichtfeld
            </mat-error>
          </mat-form-field>
        </div>
        <div fxLayout="row" fxLayoutGap="20px grid" fxLayoutAlign="left" class="margin-below">
            <mat-form-field fxFlex="15">
              <input matInput type="text" placeholder="Benutzername" formControlName="user" required>
            </mat-form-field>
            <mat-form-field fxFlex="15">
              <input matInput type="password" placeholder="Passwort" formControlName="password">
            </mat-form-field>
        </div>
        <div fxLayout="row" fxLayoutGap="20px grid" fxLayoutAlign="left" class="margin-below">
            <mat-form-field fxFlex="30">
              <input matInput type="text" placeholder="Identifier des Standard-Katalogs" formControlName="defaultCatalogIdentifier" required>
            </mat-form-field>
        </div>
        <div fxLayout="row" fxLayoutGap="20px grid" fxLayoutAlign="left center" class="margin-below">
          <div class="form-buttons">
            <button mat-button color="primary" (click)="checkDbConnection()" [disabled]="dbConnectionCheck == 'working'" data-test="checkDbConnection">
              <mat-icon class="inline-valigned">cloud</mat-icon>
              Verbindung testen
            </button>
          </div>
          <div *ngIf="dbConnectionCheck != null" fxLayoutAlign="left center">
            <mat-icon class="inline-valigned">{{statusIcon(dbConnectionCheck)}}</mat-icon>&nbsp;
            <b>{{statusMsg(dbConnectionCheck)}}</b>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <mat-card class="margin-below" [formGroup]="configForm.get('elasticsearch')">
      <mat-card-header>
        <mat-card-title>Elasticsearch</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div fxLayout="row" fxLayoutGap="20px grid" fxLayoutAlign="left" class="margin-below">
          <mat-form-field fxFlex="5">
            <mat-select placeholder="Version" formControlName="version" required>
              <mat-option value="6">6</mat-option>
              <mat-option value="7">7</mat-option>
              <mat-option value="8">8</mat-option>
            </mat-select>
          </mat-form-field>
          <mat-form-field fxFlex="25">
            <input matInput type="url" placeholder="Host-URL" formControlName="url" required>
            <mat-error *ngIf="configForm.get('elasticsearch.url').hasError('required')">
              Dies ist ein Pflichtfeld
            </mat-error>
            <mat-error *ngIf="configForm.get('elasticsearch.url').hasError('elasticUrl')">
              Dies ist keine gültige Elasticsearch-URL (Bsp: http://localhost:9200)
            </mat-error>
          </mat-form-field>
        </div>
        <div fxLayout="row" fxLayoutGap="20px grid" fxLayoutAlign="left" class="margin-below">
            <mat-form-field fxFlex="15">
              <input matInput type="text" placeholder="Benutzername" formControlName="user" required>
            </mat-form-field>
            <mat-form-field fxFlex="15">
              <input matInput type="password" placeholder="Passwort" formControlName="password">
            </mat-form-field>
        </div>
        <div fxLayout="row" fxLayoutGap="20px grid" fxLayoutAlign="left" class="margin-below">
          <mat-form-field fxFlex="30">
            <input matInput type="text" placeholder="Alias-Name" formControlName="alias" required>
            <mat-error *ngIf="configForm.get('elasticsearch.alias').hasError('whitespace')">
              Es dürfen nicht nur Leerzeichen eingegeben sein
            </mat-error>
            <mat-error *ngIf="configForm.get('elasticsearch.alias').hasError('required')">
              Dies ist ein Pflichtfeld
            </mat-error>
          </mat-form-field>
        </div>
        <h4>Index-Settings (readonly, werden beim Start durch Umgebungsvariablen gesetzt):</h4>
        <div fxLayout="row" fxLayoutGap="20px grid" fxLayoutAlign="left" class="margin-below">
          <mat-form-field fxFlex="20" floatLabel="always">
            <input matInput type="text" placeholder="Index-Präfix" formControlName="prefix">
          </mat-form-field>
          <mat-form-field fxFlex="5">
            <input matInput type="text" placeholder="Shards" formControlName="numberOfShards">
          </mat-form-field>
          <mat-form-field fxFlex="5">
            <input matInput type="text" placeholder="Replicas" formControlName="numberOfReplicas">
          </mat-form-field>
        </div>
        <div fxLayout="row" fxLayoutGap="20px grid" fxLayoutAlign="left center" class="margin-below">
          <div class="form-buttons">
            <button mat-button color="primary" (click)="checkEsConnection()" [disabled]="esConnectionCheck == 'working'" data-test="checkEsConnection">
              <mat-icon class="inline-valigned">cloud</mat-icon>
              Verbindung testen
            </button>
          </div>
          <div *ngIf="esConnectionCheck != null" fxLayoutAlign="left center">
            <mat-icon class="inline-valigned">{{statusIcon(esConnectionCheck)}}</mat-icon>&nbsp;
            <b>{{statusMsg(esConnectionCheck)}}</b>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <mat-form-field>
      <input matInput type="number" placeholder="Offset Cron-Jobs in Minuten" formControlName="cronOffset">
    </mat-form-field>

    <mat-form-field>
      <input matInput placeholder="Proxy" formControlName="proxy">
    </mat-form-field>

    <mat-form-field *ngIf="profile == 'mcloud'">
      <input matInput placeholder="Portal URL" formControlName="portalUrl">
    </mat-form-field>

    <mat-card class="margin-below">
      <mat-card-header>
        <mat-card-title>Checks</mat-card-title>
      </mat-card-header>

      <mat-card-content>
        <div fxLayout="row" fxLayoutGap="20px" fxLayoutAlign="space-between center" class="margin-below"
            [formGroup]="configForm.get('urlCheck')">
          <mat-slide-toggle color="primary"
                            [checked]="configForm.get('urlCheck.active').value"
                            (change)="urlCheckTranslate(configForm.get('urlCheck.pattern').value)"
                            formControlName="active"
                            title="Planung an- / ausschalten"></mat-slide-toggle>
          <mat-form-field fxFlex>
            <mat-label>UrlCheck Cron</mat-label>
            <input matInput placeholder="* * * * *" formControlName="pattern"
                  (keyup)="urlCheckTranslate(configForm.get('urlCheck.pattern').value)" data-test="urlCheck-input">
            <button mat-button *ngIf="configForm.get('urlCheck.pattern')" matSuffix mat-icon-button aria-label="Clear"
                    (click)="clearUrlCheckInput()" data-test="urlCheck-reset">
              <mat-icon>close</mat-icon>
            </button>
            <mat-icon matSuffix (click)="showInfo = !showInfo" class="info-icon" data-test="urlCheck-info">info_outline
            </mat-icon>
            <mat-hint align="start">Syntax: Minute | Stunde | Tag(Monat) | Monat | Wochentag</mat-hint>
          </mat-form-field>
          <div fxFlex><b>{{urlCheckTranslation}}</b></div>
        </div>

        <div fxLayout="row" fxLayoutGap="20px" fxLayoutAlign="space-between center" class="margin-below"
            [formGroup]="configForm.get('indexCheck')">
          <mat-slide-toggle color="primary"
                            [checked]="configForm.get('indexCheck.active').value"
                            (change)="indexCheckTranslate(configForm.get('indexCheck.pattern').value)"
                            formControlName="active"
                            title="Planung an- / ausschalten"></mat-slide-toggle>
          <mat-form-field fxFlex>
            <mat-label>IndexCheck Cron</mat-label>
            <input matInput placeholder="* * * * *" formControlName="pattern"
                  (keyup)="indexCheckTranslate(configForm.get('indexCheck.pattern').value)" data-test="indexCheck-input">
            <button mat-button *ngIf="configForm.get('indexCheck.pattern')" matSuffix mat-icon-button aria-label="Clear"
                    (click)="clearIndexCheckInput()" data-test="indexCheck-reset">
              <mat-icon>close</mat-icon>
            </button>
            <mat-icon matSuffix (click)="showInfo = !showInfo" class="info-icon" data-test="indexCheck-info">
              info_outline
            </mat-icon>
            <mat-hint align="start">Syntax: Minute | Stunde | Tag(Monat) | Monat | Wochentag</mat-hint>
          </mat-form-field>
          <div fxFlex><b>{{indexCheckTranslation}}</b></div>
        </div>
        <mat-card class="info" *ngIf="showInfo" class="margin-below">
          <div><span>*/5 * * * *</span> Alle 5 Minuten</div>
          <div><span>45 8 * * *</span> Täglich um 8:45 Uhr</div>
          <div><span>0 6-18/2 * * *</span> Täglich zwischen 6 und 18 Uhr, alle 2h</div>
          <div><span>30 4 1 * 0,6</span> Um 4:30 Uhr am 1. Tag jeden Monats, Sa und So</div>
        </mat-card>
      </mat-card-content>
    </mat-card>


    <mat-card class="margin-below" [formGroup]="configForm.get('indexBackup')">
      <mat-card-header>
        <mat-card-title>Index-Backup</mat-card-title>
        <mat-slide-toggle color="primary"
                          [checked]="configForm.get('indexBackup.active').value"
                          (change)="indexBackupCronTranslate(configForm.get('indexBackup.cronPattern').value)"
                          formControlName="active"
                          title="Index-Backup an- / ausschalten">
        </mat-slide-toggle>
      </mat-card-header>

      <mat-card-content>

        <div fxLayout="row" fxLayoutGap="20px" fxLayoutAlign="space-between center" class="margin-below">
          <mat-form-field fxFlex>
            <mat-label>Cron</mat-label>
            <input matInput placeholder="* * * * *" formControlName="cronPattern"
                   (keyup)="indexBackupCronTranslate(configForm.get('indexBackup.cronPattern').value)"
                   data-test="indexBackupCron-input">
            <button mat-button *ngIf="configForm.get('indexBackup.cronPattern')" matSuffix mat-icon-button aria-label="Clear"
                    (click)="clearIndexBackupCronInput()" data-test="indexBackupCron-reset">
              <mat-icon>close</mat-icon>
            </button>
            <mat-icon matSuffix (click)="showBackupCronInfo = !showBackupCronInfo" class="info-icon" data-test="indexBackupCron-info">
              info_outline
            </mat-icon>
            <mat-hint align="start">Syntax: Minute | Stunde | Tag(Monat) | Monat | Wochentag</mat-hint>
          </mat-form-field>
          <div fxFlex><b>{{indexBackupCronTranslation}}</b></div>
        </div>

        <mat-card class="info" *ngIf="showBackupCronInfo" class="margin-below">
          <div><span>*/5 * * * *</span> Alle 5 Minuten</div>
          <div><span>45 8 * * *</span> Täglich um 8:45 Uhr</div>
          <div><span>0 6-18/2 * * *</span> Täglich zwischen 6 und 18 Uhr, alle 2h</div>
          <div><span>30 4 1 * 0,6</span> Um 4:30 Uhr am 1. Tag jeden Monats, Sa und So</div>
        </mat-card>

        <div fxLayout="row" fxLayoutGap="20px" fxLayoutAlign="space-between center" >
          <mat-form-field fxFlex>
            <input matInput placeholder="Index (RegExp)" formControlName="indexPattern">
          </mat-form-field>
          <div fxFlex></div>
        </div>

        <div fxLayout="row" fxLayoutGap="20px" fxLayoutAlign="space-between center" class="margin-below">
          <mat-form-field fxFlex>
            <input matInput placeholder="Verzeichnis" formControlName="dir" [required]="configForm.get('indexBackup.active').value">
          </mat-form-field>
          <div fxFlex></div>
        </div>

      </mat-card-content>
    </mat-card>

    <mat-card>
      <mat-card-header [formGroup]="configForm.get('mail')">
        <mat-card-title>Email-Benachrichtigungen</mat-card-title>
        <mat-slide-toggle color="primary" [checked]="configForm.get('mail.enabled')"
                          title="Email-Benachrichtigungen an- / ausschalten" formControlName="enabled"
                          (click)="$event.stopImmediatePropagation()"
        >
        </mat-slide-toggle>
      </mat-card-header>

      <mat-card-content>
        <mat-form-field [formGroup]="configForm.get('mail.mailServer')">
          <input matInput placeholder="Mail-Server" formControlName="host" required>
        </mat-form-field>
        &nbsp;:&nbsp;
        <mat-form-field [formGroup]="configForm.get('mail.mailServer')">
          <input matInput placeholder="Port" formControlName="port" required>
        </mat-form-field>
        <br/>
        <div [formGroup]="configForm.get('mail.mailServer')">
          <mat-checkbox color="primary"
                        formControlName="secure">
            Secured Connection
          </mat-checkbox>
        </div>
        <br/>
        <mat-form-field [formGroup]="configForm.get('mail.mailServer.auth')">
          <input matInput placeholder="User" formControlName="user">
        </mat-form-field>
        &nbsp;&nbsp;
        <mat-form-field [formGroup]="configForm.get('mail.mailServer.auth')">
          <input type="password" matInput placeholder="Passwort" formControlName="pass">
        </mat-form-field>
        <br/>
        <mat-form-field [formGroup]="configForm.get('mail')">
          <input matInput placeholder="Absender" formControlName="from" required>
        </mat-form-field>
        &nbsp;&nbsp;
        <mat-form-field [formGroup]="configForm.get('mail')">
          <input matInput placeholder="Empfänger" formControlName="to" required>
        </mat-form-field>
        <br/>
        <mat-form-field [formGroup]="configForm.get('mail')">
          <input matInput placeholder="Betreff-Tag" formControlName="subjectTag">
        </mat-form-field>
        <br/><br/>
        <mat-form-field style="width: 250px">
          <mat-label matPrefix>Benachrichtigungs-Schwelle:</mat-label>
          <input matInput type="number" min="1" max="100" style="text-align: right; width: 50px"
                 formControlName="maxDiff">
          <mat-icon [inline]="true" style="padding-left: 1px" matSuffix>%</mat-icon>
        </mat-form-field>
      </mat-card-content>
    </mat-card>

  </form>

  <div class="form-buttons">
    <button mat-button (click)="reset()" data-test="reset">Zurücksetzen</button>
    <div class="flex-space"></div>
    <button mat-button color="primary" (click)="save()" [disabled]="!configForm.valid" data-test="save">Speichern
    </button>
  </div>
</div>
