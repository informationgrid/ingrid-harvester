<!--
    ==================================================
    ingrid-harvester
    ==================================================
    Copyright (C) 2017 - 2024 wemove digital solutions GmbH
    ==================================================
    Licensed under the EUPL, Version 1.2 or - as soon they will be
    approved by the European Commission - subsequent versions of the
    EUPL (the "Licence");

    You may not use this work except in compliance with the Licence.
    You may obtain a copy of the Licence at:

    https://joinup.ec.europa.eu/collection/eupl/eupl-text-eupl-12

    Unless required by applicable law or agreed to in writing, software
    distributed under the Licence is distributed on an "AS IS" basis,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the Licence for the specific language governing permissions and
    limitations under the Licence.
    ==================================================
-->

<page-template label="Konfiguration">
  <ng-container left-side>
    <aside contextHelp="about_config"></aside>
  </ng-container>

  @if (configForm) {
    <ng-container main-content>
      <div class="sticky-action-bar">
        <button
          matButton="outlined"
          (click)="reset()"
          data-test="reset"
        >
          Zurücksetzen
        </button>
        <button
          matButton="filled"
          color="primary"
          (click)="save()"
          [disabled]="!configForm.valid"
          data-test="save"
        >
          Speichern
        </button>
      </div>

      <form [formGroup]="configForm">
        <!-- Datenbank -->
        <mat-card
          class="form-section"
          [formGroup]="configForm.get('database')"
          data-test="config-database"
        >
          <mat-card-header contextHelp="config_database">
            <mat-card-title>Datenbank</mat-card-title>
          </mat-card-header>

          <mat-card-content>
            <div class="ingrid-row">
              <mat-form-field class="ingrid-col-10 ingrid-col-md-3">
                <mat-label>Datenbank</mat-label>
                <mat-select formControlName="type" required>
                  <mat-option value="postgresql">PostgreSQL</mat-option>
                </mat-select>
              </mat-form-field>
              <mat-form-field class="ingrid-col-10 ingrid-col-md-7">
                <mat-label>Verbindungsstring</mat-label>
                <input matInput type="url" formControlName="connectionString">
              </mat-form-field>
            </div>

            <div class="ingrid-row">
              <mat-form-field class="ingrid-col-10 ingrid-col-md-7">
                <mat-label>URL</mat-label>
                <input matInput type="url" formControlName="host">
              </mat-form-field>
              <mat-form-field class="ingrid-col-10 ingrid-col-md-3">
                <mat-label>Port</mat-label>
                <input matInput type="number" formControlName="port">
              </mat-form-field>
            </div>

            <div class="ingrid-row">
              <mat-form-field class="ingrid-col-10">
                <mat-label>Datenbank-Name</mat-label>
                <input matInput formControlName="database">
              </mat-form-field>
            </div>

            <div class="ingrid-row">
              <mat-form-field class="ingrid-col-md-5 ingrid-col-10">
                <mat-label>Benutzername</mat-label>
                <input matInput type="text" formControlName="user" required>
                @if (configForm.get('database.user').hasError('required')) {
                  <mat-error>
                    Dies ist ein Pflichtfeld
                  </mat-error>
                }
              </mat-form-field>
              <mat-form-field class="ingrid-col-md-5 ingrid-col-10">
                <mat-label>Passwort</mat-label>
                <input matInput type="password" formControlName="password">
              </mat-form-field>
            </div>

            <div class="ingrid-row">
              <button
                matButton="filled"
                color="primary"
                [disabled]="dbConnectionCheck == 'working'"
                (click)="checkDbConnection()"
                data-test="checkDbConnection"
              >
                <mat-icon svgIcon="cloud" />
                Verbindung testen
              </button>
              @if (dbConnectionCheck != null) {
                <div class="inline-flex align-items-center gap-4">
                  <mat-icon svgIcon={{statusIcon(dbConnectionCheck)}} />
                  <b>{{ statusMsg(dbConnectionCheck) }}</b>
                </div>
              }
            </div>
          </mat-card-content>
        </mat-card>

        <!-- Elasticsearch -->
        <mat-card
          class="form-section"
          [formGroup]="configForm.get('elasticsearch')"
        >
          <mat-card-header contextHelp="config_elasticsearch">
            <mat-card-title>Elasticsearch</mat-card-title>
          </mat-card-header>

          <mat-card-content>
            <div class="ingrid-row">
              <mat-form-field class="ingrid-col-md-2 ingrid-col-10">
                <mat-label>Version</mat-label>
                <mat-select formControlName="version" required>
                  <mat-option value="6">6</mat-option>
                  <mat-option value="7">7</mat-option>
                  <mat-option value="8">8</mat-option>
                  <mat-option value="9">9</mat-option>
                </mat-select>
              </mat-form-field>
              <mat-form-field class="ingrid-col-md-5 ingrid-col-10">
                <mat-label>Host-URL</mat-label>
                <input matInput type="url" formControlName="url" required>
                @if (configForm.get('elasticsearch.url').hasError('required')) {
                  <mat-error>
                    Dies ist ein Pflichtfeld
                  </mat-error>
                }
                @if (configForm.get('elasticsearch.url').hasError('elasticUrl')) {
                  <mat-error>
                    Dies ist keine gültige Elasticsearch-URL (Bsp: http://localhost:9200)
                  </mat-error>
                }
              </mat-form-field>
              <mat-checkbox
                class="ingrid-col-md-3 ingrid-col-10 mat-hint-offset"
                color="primary"
                formControlName="rejectUnauthorized"
              >
                <mat-label>Ungültige TLS Zertifikate abweisen</mat-label>
              </mat-checkbox>
            </div>

            <div class="ingrid-row">
              <mat-form-field class="ingrid-col-md-5 ingrid-col-10">
                <mat-label>Benutzername</mat-label>
                <input matInput type="text" formControlName="user" required>
              </mat-form-field>
              <mat-form-field class="ingrid-col-md-5 ingrid-col-10">
                <mat-label>Passwort</mat-label>
                <input matInput type="password" formControlName="password">
              </mat-form-field>
            </div>

            <div class="ingrid-row">
              <mat-form-field class="ingrid-col-10">
                <mat-label>Alias-Name</mat-label>
                <input matInput type="text" formControlName="alias" required>
                @if (configForm.get('elasticsearch.alias').hasError('whitespace')) {
                  <mat-error>
                    Es dürfen nicht nur Leerzeichen eingegeben sein
                  </mat-error>
                }
                @if (configForm.get('elasticsearch.alias').hasError('required')) {
                  <mat-error>
                    Dies ist ein Pflichtfeld
                  </mat-error>
                }
              </mat-form-field>
            </div>

            <div class="mb-24">
              Index-Settings (readonly) werden beim Start durch Umgebungsvariablen gesetzt:
            </div>

            <div class="ingrid-row">
              <mat-form-field class="ingrid-col-md-3 ingrid-col-10" floatLabel="always">
                <mat-label>Index-Präfix</mat-label>
                <input matInput type="text" formControlName="prefix" readonly>
              </mat-form-field>
              <mat-form-field class="ingrid-col-md-3 ingrid-col-10">
                <mat-label>Index-Name</mat-label>
                <input matInput type="text" formControlName="index" readonly>
              </mat-form-field>
              <mat-form-field class="ingrid-col-md-2 ingrid-col-10">
                <mat-label>Shards</mat-label>
                <input matInput type="text" formControlName="numberOfShards" readonly>
              </mat-form-field>
              <mat-form-field class="ingrid-col-md-2 ingrid-col-10">
                <mat-label>Replicas</mat-label>
                <input matInput type="text" formControlName="numberOfReplicas" readonly>
              </mat-form-field>
            </div>

            <div class="ingrid-row">
              <button
                matButton="filled"
                color="primary"
                [disabled]="esConnectionCheck == 'working'"
                (click)="checkEsConnection()"
                data-test="checkEsConnection"
              >
                <mat-icon svgIcon="cloud" class="inline-valigned" />
                Verbindung testen
              </button>
              @if (esConnectionCheck != null) {
                <div class="inline-flex align-items-center gap-4">
                  <mat-icon svgIcon={{statusIcon(esConnectionCheck)}} color={{statusColor(esConnectionCheck)}}
                            class="inline-valigned" />
                  <b>{{ statusMsg(esConnectionCheck) }}</b>
                </div>
              }
            </div>
          </mat-card-content>
        </mat-card>

        <!-- Zusätzliche Einstellungen -->
        <mat-card class="form-section">
          <mat-card-header contextHelp="config_additional_settings">
            <mat-card-title>Zusätzliche Einstellungen</mat-card-title>
          </mat-card-header>

          <mat-card-content>
            <div class="ingrid-row">
              <mat-form-field class="ingrid-col-md-5 ingrid-col-10">
                <mat-label>Offset Cron-Jobs in Minuten</mat-label>
                <input matInput type="number" formControlName="cronOffset">
              </mat-form-field>
              <mat-form-field class="ingrid-col-md-5 ingrid-col-10">
                <mat-label>Log-Level für fehlende Format-Mappings</mat-label>
                <mat-select formControlName="mappingLogLevel" required>
                  <mat-option value="info">INFO</mat-option>
                  <mat-option value="warn">WARNING</mat-option>
                </mat-select>
              </mat-form-field>
            </div>
            <div class="ingrid-row">
              <mat-form-field class="ingrid-col-md-7 ingrid-col-10">
                <mat-label>Proxy URL</mat-label>
                <input matInput formControlName="proxy">
              </mat-form-field>
              <mat-checkbox class="ingrid-col-md-3 ingrid-col-10 mat-hint-offset" color="primary"
                            formControlName="allowAllUnauthorizedSSL">
                <mat-label>Unauthorisierte Verbindungen über Proxy erlauben</mat-label>
              </mat-checkbox>
            </div>

            <div class="ingrid-row">
              <mat-form-field class="ingrid-col-10">
                <mat-label>Portal URL</mat-label>
                <input matInput formControlName="portalUrl">
              </mat-form-field>
            </div>
          </mat-card-content>
        </mat-card>

        <!-- Checks -->
        <mat-card class="form-section">
          <mat-card-header contextHelp="config_checks">
            <mat-card-title>Checks</mat-card-title>
          </mat-card-header>

          <mat-card-content>
            <harvester-cronjob-form-field
              title="Url Check"
              [form]="configForm"
              formKey="urlCheck"
              activeKeyName="active"
              cronKeyName="pattern" />
            <harvester-cronjob-form-field
              title="Index Check"
              [form]="configForm"
              formKey="indexCheck"
              activeKeyName="active"
              cronKeyName="pattern" />
          </mat-card-content>
        </mat-card>

        <!-- Index-Backup -->
        <mat-card
          class="form-section"
          [formGroup]="configForm.get('indexBackup')"
        >
          <mat-card-header contextHelp="config_index_backup">
            <mat-card-title>Index-Backup</mat-card-title>
          </mat-card-header>

          <mat-card-content>
            <harvester-cronjob-form-field
              title="Index-Backup"
              [form]="configForm"
              formKey="indexBackup"
              activeKeyName="active"
              cronKeyName="cronPattern" />

            <div class="ingrid-row">
              <mat-form-field class="ingrid-col-10">
                <mat-label>Index (RegExp)</mat-label>
                <input
                  matInput
                  formControlName="indexPattern"
                >
              </mat-form-field>
            </div>

            <div class="ingrid-row">
              <mat-form-field class="ingrid-col-10">
                <mat-label>Verzeichnis</mat-label>
                <input
                  matInput
                  formControlName="dir"
                  [required]="configForm.get('indexBackup.active').value"
                >
              </mat-form-field>
            </div>
          </mat-card-content>
        </mat-card>

        <!-- Harvesting Differenzen -->
        <mat-card class="form-section">
          <mat-card-header contextHelp="config_harvesting_differences">
            <mat-card-title>Harvesting Differenzen</mat-card-title>
          </mat-card-header>

          <mat-card-content>
            <div class="mb-24">
              Wenn bereits bestehende Datensätze nicht im laufenden Harvesting vorhanden sind, dann
            </div>

            <div
              class="ingrid-row align-items-center"
              [formGroup]="configForm.get('harvesting.mail')"
            >
              <mat-slide-toggle
                class="ingrid-col-none mat-hint-offset"
                color="accent"
                title="E-Mail-Benachrichtigungen für eingestellte Harvesting-Differenz an-/ausschalten"
                formControlName="enabled"
                [checked]="configForm.get('harvesting.mail.enabled')"
                (click)="$event.stopImmediatePropagation()"
              >
              </mat-slide-toggle>
              <span class="ingrid-col-none mat-hint-offset">
                E-Mail senden ab einer Differenz von
              </span>
              <mat-form-field class="ingrid-col-md-3 ingrid-col-10">
                <mat-label>Benachrichtigungs-Schwelle</mat-label>
                <input matInput class="text-right" type="number" min="1" max="100" formControlName="minDifference">
                <mat-icon [inline]="true" style="padding-left: 1px; line-height: initial" matSuffix>%</mat-icon>
              </mat-form-field>
            </div>

            <div
              class="ingrid-row align-items-center"
              [formGroup]="configForm.get('harvesting.cancel')"
            >
              <mat-slide-toggle
                class="ingrid-col-none mat-hint-offset"
                color="accent"
                title="Harvesting-Abbruch für eingestellte Harvesting-Differenz an-/ausschalten"
                formControlName="enabled"
                [checked]="configForm.get('harvesting.cancel.enabled')"
                (click)="$event.stopImmediatePropagation()"
              >
              </mat-slide-toggle>
              <span class="ingrid-col-none mat-hint-offset">
                Harvesting abbrechen ab einer Differenz von
              </span>
              <mat-form-field class="ingrid-col-md-3 ingrid-col-10">
                <mat-label>Abbruchs-Schwelle</mat-label>
                <input matInput class="text-right" type="number" min="1" max="100" formControlName="minDifference">
                <mat-icon [inline]="true" style="padding-left: 1px; line-height: initial" matSuffix>%</mat-icon>
              </mat-form-field>
            </div>
          </mat-card-content>
        </mat-card>

        <!-- E-Mail-Einstellungen -->
        <mat-card class="form-section">
          <mat-card-header
            contextHelp="config_email"
            [formGroup]="configForm.get('mail')"
          >
            <mat-card-title>E-Mail-Einstellungen</mat-card-title>
            <mat-slide-toggle
              class="ml-auto align-self-center"
              color="accent"
              title="E-Mail-Benachrichtigungen an- / ausschalten"
              formControlName="enabled"
              [checked]="configForm.get('mail.enabled')"
              (click)="$event.stopImmediatePropagation()"
            >
            </mat-slide-toggle>
          </mat-card-header>

          <mat-card-content>
            <div class="mb-24">Server</div>
            <div class="ingrid-row">
              <mat-form-field class="ingrid-col-md-4 ingrid-col-10" [formGroup]="configForm.get('mail.mailServer')">
                <mat-label>E-Mail-Server</mat-label>
                <input matInput formControlName="host" required>
              </mat-form-field>
              <mat-form-field
                class="ingrid-col-md-1 ingrid-col-5" [formGroup]="configForm.get('mail.mailServer')">
                <mat-label>Port</mat-label>
                <input matInput type="number" formControlName="port" required>
              </mat-form-field>
              <div
                class="ingrid-col-md-2 ingrid-col-10 mat-hint-offset"
                [formGroup]="configForm.get('mail.mailServer')">
                <mat-checkbox color="primary" formControlName="secure">
                  Secure Connection
                </mat-checkbox>
              </div>
              <div
                class="ingrid-col-md-3 ingrid-col-10 mat-hint-offset"
                [formGroup]="configForm.get('mail.mailServer.tls')">
                <mat-checkbox color="primary" formControlName="rejectUnauthorized">
                  Ungültige TLS Zertifikate abweisen
                </mat-checkbox>
              </div>
            </div>

            <div class="ingrid-row">
              <mat-form-field
                class="ingrid-col-md-5 ingrid-col-10"
                [formGroup]="configForm.get('mail.mailServer.auth')"
              >
                <mat-label>User</mat-label>
                <input matInput formControlName="user">
              </mat-form-field>
              <mat-form-field
                class="ingrid-col-md-5 ingrid-col-10"
                [formGroup]="configForm.get('mail.mailServer.auth')"
              >
                <mat-label>Passwort</mat-label>
                <input type="password" matInput formControlName="pass">
              </mat-form-field>
            </div>

            <div class="mb-24">Template</div>
            <div class="ingrid-row">
              <mat-form-field
                class="ingrid-col-md-5 ingrid-col-10"
                [formGroup]="configForm.get('mail')"
              >
                <mat-label>Absender</mat-label>
                <input matInput formControlName="from" required>
              </mat-form-field>
              <mat-form-field
                class="ingrid-col-md-5 ingrid-col-10"
                [formGroup]="configForm.get('mail')"
              >
                <mat-label>Empfänger</mat-label>
                <input matInput formControlName="to" required>
              </mat-form-field>
            </div>

            <div class="ingrid-row">
              <mat-form-field
                class="ingrid-col-md-5 ingrid-col-10"
                [formGroup]="configForm.get('mail')"
              >
                <mat-label>Betreff-Tag</mat-label>
                <input matInput formControlName="subjectTag">
              </mat-form-field>
            </div>
          </mat-card-content>
        </mat-card>
      </form>
    </ng-container>
  }
</page-template>
