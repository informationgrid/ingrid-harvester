<!--
    ==================================================
    ingrid-harvester
    ==================================================
    Copyright (C) 2017 - 2024 wemove digital solutions GmbH
    ==================================================
    Licensed under the EUPL, Version 1.2 or - as soon they will be
    approved by the European Commission - subsequent versions of the
    EUPL (the "Licence");

    You may not use this work except in compliance with the Licence.
    You may obtain a copy of the Licence at:

    https://joinup.ec.europa.eu/collection/eupl/eupl-text-eupl-12

    Unless required by applicable law or agreed to in writing, software
    distributed under the Licence is distributed on an "AS IS" basis,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the Licence for the specific language governing permissions and
    limitations under the Licence.
    ==================================================
-->

@if (harvesterLoaded) {
  <div class="h-full w-full overflow-y-auto">
    <div
      class="max-w-content flex-col"
      *transloco="let t; read: 'harvester'"
    >
      <aside class="my-4" contextHelp="about_harvester"></aside>

      <div class="flex-row flex-wrap gap-16">
        <button
          matButton="filled"
          color="primary"
          [disabled]="numberOfHarvesters === 0"
          (click)="importAll()"
          aria-label="{{ t('importAll') }}"
          data-test="import-all"
        >
          <mat-icon svgIcon="Harvester" />
          {{ t("importAll") }}
        </button>

        <button
          matButton="filled"
          color="primary"
          (click)="addHarvester()"
          aria-label="{{ t('add') }}"
          id="btnAddHarvester"
        >
          <mat-icon svgIcon="Add" />
          {{ t("add") }}
        </button>

        <button
          matButton="outlined"
          color="primary"
          contextHelp="about_harvester_timing"
        >
          <mat-icon svgIcon="info" />
          Ausf√ºhrung planen
        </button>

        <button
          matButton="outlined"
          color="primary"
          contextHelp="about_harvester_history"
        >
          <mat-icon svgIcon="info" />
          Historie anzeigen
        </button>
      </div>

      @for (item of harvesters | keyvalue; track item) {
        <h2>{{ item.key }}</h2>

        @for (harvester of item.value; track harvester) {
          <mat-expansion-panel class="harvester-expansion-panel" hideToggle [id]="'harvester-' + harvester.id">
            <mat-expansion-panel-header>

              <mat-panel-title>
                <div class="status-icon">
                  @if (importDetail[harvester.id]?.summary) {
                    <!-- <mat-panel-description> -->
                    @if (hasAnyErrors(harvester.id)) {
                      <mat-icon svgIcon="Error" class="warn" />
                    }
                    @if (!hasAnyProblems(harvester.id)) {
                      <mat-icon svgIcon="Success" class="success" />
                    }
                    @if (hasOnlyWarnings(harvester.id)) {
                      <mat-icon svgIcon="Error" class="warning" />
                    }
                    <!-- </mat-panel-description> -->
                  }
                  @if (importDetail[harvester.id]?.complete === false) {
                    <mat-spinner diameter="20"></mat-spinner>
                  }
                </div>

                <p class="no-wrap">
                  {{ harvester.description || harvester.defaultAttribution }}
                </p>
              </mat-panel-title>

              @if (harvester.cron?.full?.pattern || harvester.cron?.incr?.pattern) {
                <mat-icon
                  inline
                  class="scheduled-icon"
                  [svgIcon]="harvester.disable || !harvester.cron.full?.active ? 'alarm_off' : 'alarm_on' "
                  data-test="icon-schedule"
                />
              }

            </mat-expansion-panel-header>

            <app-importer-detail
              [data]="importDetail[harvester.id]"
              [cronActive]="!harvester.disable && (harvester.cron?.full?.active || harvester.cron?.incr?.active)"
              (showLog)="showLog(harvester.id)"
            ></app-importer-detail>

            <div class="flex-row flex-wrap space-between gap-8">
              <!-- primary action buttons -->
              <div class="flex-row flex-wrap gap-12">
                @if (item.key === 'CSW') {
                  <button
                    matButton="outlined"
                    color="primary"
                    [disabled]="importDetail[harvester.id]?.complete === false"
                    (click)="startImport(harvester.id, true)"
                    data-test="import"
                  >
                    <mat-icon svgIcon="Harvester" />
                    {{ t("importIncrement") }}
                  </button>
                }
                <button
                  matButton="outlined"
                  color="primary"
                  [disabled]="importDetail[harvester.id]?.complete === false"
                  (click)="startImport(harvester.id)"
                  data-test="import"
                >
                  <mat-icon svgIcon="Harvester" />
                  {{ t("import") }}
                </button>
              </div>

              <!-- secondary action buttons -->
              <div class="flex-row flex-wrap gap-12">
                <button
                  matIconButton
                  color="primary"
                  matTooltip="{{ t('edit') }}"
                  aria-label="{{ t('edit') }}"
                  (click)="edit(harvester)"
                  data-test="edit"
                >
                  <mat-icon svgIcon="cursor-edit" />
                </button>

                <button
                  matIconButton
                  color="warn"
                  matTooltip="{{ t('delete') }}"
                  aria-label="{{ t('delete') }}"
                  (click)="deleteHarvester(harvester)"
                  data-test="delete"
                >
                  <mat-icon svgIcon="Delete" />
                </button>

                <button
                  matIconButton
                  color="primary"
                  matTooltip="{{ t('more') }}"
                  aria-label="{{ t('more') }}"
                  [matMenuTriggerFor]="actionMenu"
                >
                  <mat-icon svgIcon="Options" />
                </button>
                <mat-menu #actionMenu>
                  <button
                    mat-menu-item
                    (click)="copy(harvester)"
                    data-test="copy"
                  >
                    <mat-icon svgIcon="Copy" />
                    {{ t('copy') }}
                  </button>
                  <button
                    mat-menu-item
                    (click)="schedule(harvester)"
                    data-test="schedule"
                  >
                    <mat-icon svgIcon="Schedule" />
                    {{ t('schedule') }}
                  </button>
                  <button
                    mat-menu-item
                    (click)="showHistory(harvester)"
                    data-test="history"
                  >
                    <mat-icon svgIcon="Timeline" />
                    {{ t('history') }}
                  </button>
                  <button
                    mat-menu-item
                    [disabled]="!hasAnyProblems(harvester.id)"
                    (click)="showLog(harvester.id)"
                    data-test="log"
                  >
                    <mat-icon svgIcon="Logging" />
                    {{ t('log') }}
                  </button>
                </mat-menu>
              </div>
            </div>

          </mat-expansion-panel>
        }
      }
    </div>
  </div>
}

@if (!harvesterLoaded) {
  <div class="no-harvester">
    <mat-spinner diameter="100"></mat-spinner>
  </div>
}
